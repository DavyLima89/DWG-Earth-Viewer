# .github/workflows/build-apk.yml
# Arquivo para compilar APK automaticamente no GitHub

name: ğŸš€ Build DWG Earth Viewer APK

on:
  # Trigger manual (vocÃª pode executar quando quiser)
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Nome da versÃ£o (ex: v1.0.0)'
        required: true
        default: 'v1.0.0'
        
  # Trigger automÃ¡tico ao fazer push
  push:
    branches: [ main, master ]
    
  # Trigger ao criar Pull Request
  pull_request:
    branches: [ main, master ]

jobs:
  build-apk:
    name: ğŸ“± Gerar APK do DWG Earth Viewer
    runs-on: ubuntu-latest
    
    steps:
    # 1. Baixar cÃ³digo do repositÃ³rio
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    # 2. Configurar Java (necessÃ¡rio para Android)
    - name: â˜• Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    # 3. Dar permissÃ£o de execuÃ§Ã£o ao Gradle
    - name: ğŸ”§ Configurar permissÃµes do Gradle
      run: chmod +x gradlew
      
    # 4. Limpar projeto anterior
    - name: ğŸ§¹ Limpar build anterior
      run: ./gradlew clean
      
    # 5. Compilar o projeto
    - name: ğŸ”¨ Compilar projeto
      run: ./gradlew build
      
    # 6. Gerar APK de debug
    - name: ğŸ“± Gerar APK Debug
      run: ./gradlew assembleDebug
      
    # 7. Gerar APK de release (se tiver keystore configurado)
    - name: ğŸ“¦ Gerar APK Release (Opcional)
      run: ./gradlew assembleRelease
      continue-on-error: true
      
    # 8. Encontrar arquivo APK gerado
    - name: ğŸ” Localizar APK
      run: |
        find . -name "*.apk" -type f
        ls -la app/build/outputs/apk/debug/
        
    # 9. Upload do APK como artefato
    - name: â¬†ï¸ Upload APK Debug
      uses: actions/upload-artifact@v4
      with:
        name: DWG-Earth-Viewer-Debug-${{ github.run_number }}
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    # 10. Upload APK Release (se existir)
    - name: â¬†ï¸ Upload APK Release
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: DWG-Earth-Viewer-Release-${{ github.run_number }}
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 60
      continue-on-error: true
      
    # 11. Criar release automÃ¡tico (se executado manualmente)
    - name: ğŸ‰ Criar Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.release_name }}
        name: DWG Earth Viewer ${{ github.event.inputs.release_name }}
        body: |
          ğŸ¯ **Nova versÃ£o do DWG Earth Viewer!**
          
          ## ğŸ“± Funcionalidades:
          - âœ… VisualizaÃ§Ã£o de arquivos DWG sobre Google Earth
          - âœ… LocalizaÃ§Ã£o GPS em tempo real com seta
          - âœ… NavegaÃ§Ã£o topogrÃ¡fica interativa
          - âœ… ImportaÃ§Ã£o de projetos DWG
          
          ## ğŸ“¥ **Como instalar:**
          1. Baixe o arquivo `app-debug.apk`
          2. No Android: ConfiguraÃ§Ãµes â†’ SeguranÃ§a â†’ Permitir fontes desconhecidas
          3. Instale o APK
          4. Configure sua API Key do Google Maps
          
          ## ğŸ”‘ **API Key necessÃ¡ria:**
          - Obtenha gratuitamente em: https://console.cloud.google.com/
          - Ative Maps SDK for Android
          
          **Gerado automaticamente via GitHub Actions** ğŸ¤–
        files: |
          app/build/outputs/apk/debug/app-debug.apk
          app/build/outputs/apk/release/app-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# ConfiguraÃ§Ãµes adicionais para projetos Android
env:
  # Configurar Gradle para usar menos memÃ³ria
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"
